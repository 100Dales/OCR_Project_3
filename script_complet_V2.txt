#!/bin/bash -ex

# Confirmation du lancement du script
while [ -z $REPONSE ] || ([ $REPONSE != "o" ] && [ $REPONSE != "n" ])
do
   read -p "Voulez-vous lancer le script de configuration de poste ? (o/n) : " REPONSE
done

if [ $REPONSE = "o" ]
then
   read -p "Entrer l'adresse IP du poste concerné (ex: 192.168.100.X pour la salle Abeille ou 192.168.101.X pour la salle Baobab : " ADRESSE
   IP=$(echo $ADRESSE)
   LAN=$(echo $ADRESSE | cut -d '.' -f3)
   PC=$(echo $ADRESSE | cut -d '.' -f4)

if [ $LAN = "100" ]
then

ssh -T abeille@$IP <<'EOL'
    NEW_USER=$(echo "ABE-$PC")
    NEW_HOSTNAME=$(echo "CLT-ABE-$PC")
    OLD_USER=$(cat /etc/passwd | grep "ABE-")
    # Mise à jour du poste cible
      sudo -i
      apt update
      apt upgrade -y
    # Création d'un hostname unique
      hostname $NEW_HOSTNAME
    # Suppression de l'ancien utilisateur
      userdel -h -r $OLD_USER
    # Création du futur utilisateur
      useradd -m -s /bin/bash $NEW_USER
      echo -e "P@ssw0rd!\nP@ssw0rd!" | (passwd --stdin $NEW_USER)
EOL


else [ $LAN = "101" ]

ssh -T baobab@$IP <<'EOL'
    NEW_USER=$(echo "BAO-$PC")
    NEW_HOSTNAME=$(echo "CLT-BAO-$PC")
    OLD_USER=$(cat /etc/passwd | grep "BAO-")
    # Mise à jour du poste cible
      sudo -i
      apt update
      apt upgrade -y
    # Création d'un hostname unique
      hostname $NEW_HOSTNAME
    # Suppression de l'ancien utilisateur
      userdel -h -r $OLD_USER
    # Création du futur utilisateur
      useradd -m -s /bin/bash $NEW_USER
      echo -e "P@ssw0rd!\nP@ssw0rd!" | (passwd --stdin $NEW_USER)
EOL

   fi

else [ $REPONSE = "n" ]
  echo "---------------- Annulation du lancement ---------------"
fi


















